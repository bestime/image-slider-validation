/*!
 * canvas 图片滑块验证插件
 * @author Jiang Yang (Bestime)
 * @QQ 1174295440
 * @see https://github.com/bestime/image-slider-validation
 * @update 2020-01-22 18:08
 * 
 */
var ImageSliderValidation=function(){function e(e){try{e.parentNode.removeChild(e)}catch(e){}}function n(e,n,t){e=e||window.event,n=!1!==n,t=!1!==t,n&&window.event?window.event.cancelBubble=!0:e.stopPropagation(),t&&window.event?window.event.returnValue=!1:e.preventDefault()}function t(){return"https://picsum.photos/300/150/?image=500"}function i(e,n,i){function c(n){if("canvas"===e){var t=document.createElement("img");t.crossOrigin="Anonymous",t.onload=function(){i(t,n.x,n.y)},t.src=n.src}else o(n.src,function(e){i(e,n.x,n.y)})}n?n(c):c({src:t(),x:0,y:0})}function o(e,n){function t(){c++,c===e.length&&n([i,o])}var i=document.createElement("img");i.onload=t,i.crossOrigin="Anonymous",i.className="isv-back",i.src=e[0];var o=document.createElement("img");o.onload=t,o.crossOrigin="Anonymous",o.className="isv-slider",o.src=e[1];var c=0}function c(e,n){var t=document.createElement("canvas");return t.width=e,t.height=n,t}function s(){return'    <div class="isv-loading">      <svg class="isvg" x="0px" y="0px" viewBox="0 0 150 150">        <circle class="isvg-inner" cx="75" cy="75" r="60"/>      </svg>    </div>    '}function a(e,n,t,i,o){function c(e){e=l?e.targetTouches[0]:e||window.event,a(e.clientX-v)}function s(){i(p),document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",s),document.removeEventListener("touchmove",c),document.removeEventListener("touchend",s),document.removeEventListener("touchcancel",s)}function a(e){var i=r.offsetWidth-n;i<0&&(i=0),e>i?e=i:e<0&&(e=0),p=e,u.style.left=p+"px",d.style.width=p+n-2+"px",t(p)}var r=document.createElement("div");r.className="isv_handler_box",r.innerHTML="<span></span><b>"+f+"</b><i></i>",r.style.width=e+"px";var u,d,m,v=0,p=0;return setTimeout(function(){u=r.getElementsByTagName("span")[0],d=r.getElementsByTagName("i")[0],m=r.getElementsByTagName("b")[0],l?u.ontouchstart=function(e){e=e.targetTouches[0],v=e.clientX-p,document.addEventListener("touchmove",c),document.addEventListener("touchend",s),document.addEventListener("touchcancel",s),o()}:u.onmousedown=function(e){e=e||window.event,v=e.clientX-p,document.addEventListener("mousemove",c),document.addEventListener("mouseup",s),o()}},50),{el:r,updateLabel:function(e){m.innerHTML=e},reset:function(){a(0),m.innerHTML=f},setSuccess:function(){m.innerHTML="验证成功"},setError:function(){m.innerHTML="验证失败"}}}var l="ontouchstart"in document.documentElement,r=l?window.devicePixelRatio:1,u=Math.PI,d=10,m=42*r,v=m+2*d*r,f="向右拖动滑块填充拼图",p=19;return function(t){function o(e){U.classList.add("success"),G.setSuccess(),N=setTimeout(function(){t.success&&t.success(e,R,E)},1e3)}function l(e){e=!0===e,U.classList.add("fail"),G.setError(),b=setTimeout(function(){L(e),t.error&&t.error(E)},1e3)}function h(){x=!0,U.classList.add("loading"),"canvas"===A?(k.clearRect(0,0,P,S),I.clearRect(0,0,P,S),M.width=P):(e(C),e(M)),i(A,t.onGetImage,function(e,n,t){if("canvas"===A){D=n,R=t+p,w(),g(k,"fill",D,R),g(I,"clip",D,R),k.drawImage(e,0,0,P,S),I.drawImage(e,0,0,P,S);t=R-2*d+2;var i=I.getImageData(D,t,v,v);M.width=v,I.putImageData(i,0,t)}else C=e[0],M=e[1],V.appendChild(e[0]),V.appendChild(e[1]);x=!1,U.classList.remove("loading")})}function g(e,n,t,i){t+=1,e.strokeStyle="rgba(255,255,255,0.5)",e.beginPath(),e.moveTo(t,i),e.lineTo(t+m/2,i),e.arc(t+m/2,i-d+8,d-2,.5*u,2.5*u),e.lineTo(t+m/2,i),e.lineTo(t+m,i),e.lineTo(t+m,i+m/2),e.arc(t+m+d-8,i+m/2,d-2,u,3*u),e.lineTo(t+m,i+m/2),e.lineTo(t+m,i+m),e.lineTo(t+26,i+29),e.lineTo(t,i+m),e.lineTo(t+15,i+15),e.lineTo(t,i),e.stroke(),e.fillStyle="#fff",e[n](),e.beginPath(),e.globalCompositeOperation="xor",e.fill()}function w(){R<p?R=p:R>S-v+p&&(R=S-v+p),D<v?D=v:D>P-v&&(D=P-v)}function T(){clearTimeout(N),clearTimeout(b),U.classList.remove("success"),U.classList.remove("fail"),G.updateLabel(f)}function L(e){e=!0===e,e&&x||(T(),M.style.left="0px",G.reset(),e&&h())}function y(){U.classList.add("active")}function E(){U.classList.remove("active")}var x,b,N,C,M,k,I,B=t.width||100,H=t.height||100,P=B*r,S=H*r,O=t.wrapper,A=t.mode||"canvas",D=0,R=0,X=t.sliderButtonWidth||40,U=document.createElement("div"),V=document.createElement("div"),W=document.createElement("div"),_=document.createElement("div");W.className="isv-refresh",_.className="isv-close",V.className="isv-canvas",V.style.width=B+"px",V.style.height=H+"px",U.className="image-slider-validation loading",U.onclick=n,"canvas"===A&&(C=c(P,S),M=C.cloneNode(!0),C.style.width=B+"px",C.style.height=H+"px",M.style.width=v/r+"px",M.style.height=H+"px",k=C.getContext("2d"),I=M.getContext("2d"),C.className="isv-back",M.className="isv-slider",V.appendChild(C),V.appendChild(M)),V.appendChild(W),V.appendChild(_),U.innerHTML+=s(),U.appendChild(V);var G=a(B,X,function(e){M.style.left=e+"px"},function(e){"canvas"===A?(clearTimeout(N),clearTimeout(b),Math.abs(e-D)<=2?o(e):l()):t.onMouseUp&&t.onMouseUp(e,function(){clearTimeout(N),clearTimeout(b),o(e)},l)},function(){T()});return U.appendChild(G.el),O.appendChild(U),h(),_.onclick=function(){E(),t.close&&t.close()},W.onclick=function(){L(!0)},{show:y,close:E,reLoad:function(){L(!0)}}}}();